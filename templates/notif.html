<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OWEN - Organic Waste Energy - OWEN PLUS</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Poppins", sans-serif;
        background-color: #f3f4f6;
        overflow: hidden;
      }

      @keyframes slideInLeft {
        from {
          opacity: 0;
          transform: translateX(-20px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      .animate-slideInLeft {
        animation: slideInLeft 0.3s ease-out forwards;
      }

      /* Keyframes untuk Fade-In */
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .animate-fadeIn {
        animation: fadeIn 0.3s ease-out forwards;
      }

      @keyframes slideInBottomBounce {
        0% {
          opacity: 0;
          transform: translateY(50px);
        }
        60% {
          transform: translateY(-10px);
        }
        80% {
          transform: translateY(5px);
        }
        100% {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .animate-slideInBottomBounce {
        animation: slideInBottomBounce 0.5s ease-out forwards;
      }

      /* Style untuk card monitoring */
      .monitoring-card {
        background-color: white;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1),
          0 1px 2px 0 rgba(0, 0, 0, 0.06);
        padding: 1.5rem;
      }

      .monitoring-item {
        margin-bottom: 1rem;
      }

      .monitoring-item:last-child {
        margin-bottom: 0;
      }

      .monitoring-label {
        margin-bottom: 0.25rem;
        display: block;
      }

      .monitoring-value {
        font-size: 1.125rem;
        color: #374151;
      }

      /* Style untuk notifikasi (tetap ada di bawah monitoring atau bisa diatur posisinya) */
      .notification-card {
        background-color: #fff;
        border-left: 4px solid;
        padding: 1rem;
        border-radius: 0.25rem;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1),
          0 1px 2px 0 rgba(0, 0, 0, 0.06);
        margin-bottom: 1rem;
      }

      .notification-yellow {
        border-left-color: #facc15; /* Yellow 500 */
      }

      .notification-green {
        border-left-color: #22c55e; /* Green 500 */
      }

      .notification-red {
        border-left-color: #ef4444; /* Red 500 */
      }

      .notification-title {
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
      }

      .notification-icon {
        width: 1.5rem;
        height: 1.5rem;
      }

      .notification-text {
        color: #4b5563;
        font-size: 0.875rem;
        margin-bottom: 0.25rem;
      }

      .notification-time {
        color: #6b7280;
        font-size: 0.75rem;
      }
    </style>
  </head>
  <body class="min-h-screen flex flex-col">
    <div class="bg-green-600 p-4 flex items-center justify-center shadow-md">
      <h1 class="text-white text-lg font-semibold animate-fadeIn">OWEN PLUS</h1>
      <div class="w-6 h-6"></div>
    </div>

    <div class="container mx-auto p-4 space-y-4 flex-grow overflow-y-auto">
      <div class="flex w-full space-x-4">
        <div class="w-1/2">
          <div id="chart-container" class="bg-white rounded-md shadow p-4">
            <h2 class="font-semibold text-gray-700 mb-2">Grafik Tegangan</h2>
            <div id="chart"></div>
          </div>
        </div>
        <div class="w-1/2 space-y-4">
          <div class="monitoring-card">
            <h2 class="font-semibold text-gray-700 mb-4">Monitoring Sistem</h2>
            <div id="monitoring-data">
              <div class="monitoring-item">
                <span class="monitoring-label">Suhu</span>
                <span class="monitoring-value">30¬∞C</span>
              </div>
              <div class="monitoring-item">
                <span class="monitoring-label">Kelembaban</span>
                <span class="monitoring-value">65%</span>
              </div>
              <div class="monitoring-item">
                <span class="monitoring-label">Keasaman</span>
                <span class="monitoring-value">10 ph</span>
              </div>
            </div>
          </div>

          <div id="prediction-notification" class="space-y-2"></div>
        </div>
      </div>
    </div>
    <div class="navigation bg-green-600 py-2 rounded-md shadow">
      <div class="flex justify-around items-center">
        <a
          href="{{ url_for('index') }}"
          class="text-white transition duration-200 ease-in-out hover:scale-110 hover:animate-wobble"
        >
          <div class="flex flex-col items-center">
            <span class="text-xl">üè†</span>
            <span class="text-xs">Beranda</span>
          </div>
        </a>

        <a
          href="{{ url_for('menu') }}"
          class="text-white transition duration-200 ease-in-out hover:scale-110 hover:animate-wobble"
        >
          <div class="flex flex-col items-center">
            <span class="text-xl">üìä</span>
            <span class="text-xs">Menu</span>
          </div>
        </a>

        <a
          href="{{ url_for('notif') }}"
          class="text-white transition duration-200 ease-in-out hover:scale-110 hover:animate-wobble"
        >
          <div class="flex flex-col items-center">
            <span class="text-xl">üîî</span>
            <span class="text-xs">Notifikasi</span>
          </div>
        </a>

        <a
          href="{{ url_for('profil') }}"
          class="text-white transition duration-200 ease-in-out hover:scale-110 hover:animate-wobble"
        >
          <div class="flex flex-col items-center">
            <span class="text-xl">üë§</span>
            <span class="text-xs">Profil</span>
          </div>
        </a>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script>
      const getData = async () => {
        try {
          const response = await fetch("/all_data");
          if (!response.ok) {
            throw new Error("Network response was not ok");
          }
          const data = await response.json();
          return data;
        } catch (error) {
          console.error("Error fetching data:", error);
          return [];
        }
      };

      (async () => {
        let datas = await getData();

        var options = {
          chart: {
            type: "line",
            toolbar: {
              show: false,
            },
            animations: {
              enabled: true,
              easing: "linear",
              dynamicAnimation: {
                speed: 1000,
              },
            },
          },
          markers: {
            size: 5,
          },
          stroke: {
            curve: "smooth",
            width: 2,
          },

          colors: ["#16a34a"],
          series: [
            {
              name: "tegangan",
              data: datas.slice(-7).map((data) => data.tegangan),
            },
          ],

          xaxis: {
            categories: Array.from(
              { length: Math.min(7, datas.length) },
              (_, i) => {
                const index = datas.length - 7 + i;
                const hour = new Date().getHours() - (6 - i); // Assuming data points are roughly hourly and recent
                return hour.toString().padStart(2, "0");
              }
            ),
            labels: {
              formatter: function (value) {
                return value;
              },
            },
          },
        };

        var chart = new ApexCharts(document.querySelector("#chart"), options);

        chart.render();

        // Function to update the chart with new data
        const updateChart = async () => {
          const newData = await getData();
          datas = newData; // Update the global datas array
          const newDataPoints = datas.slice(-7).map((data) => data.tegangan);
          const newCategories = Array.from(
            { length: Math.min(7, datas.length) },
            (_, i) => {
              const now = new Date();
              const pastHour = new Date(
                now.getTime() - (6 - i) * 60 * 60 * 1000
              );
              return pastHour.getHours().toString().padStart(2, "0");
            }
          );

          chart.updateSeries([
            {
              data: newDataPoints,
            },
          ]);
          chart.updateOptions({
            xaxis: {
              categories: newCategories,
            },
          });
        };

        setInterval(updateChart, 5000);

        // Data monitoring (simulasi)
        const monitoringDataElement =
          document.getElementById("monitoring-data");
        const monitoringItems = [
          { label: "Suhu", value: "30¬∞C" },
          { label: "Kelembaban", value: "65%" },
          { label: "Keasaman", value: "10" },
        ];
        let currentIndex = 0;

        async function updateMonitoringData() {
          const datas = await getData();
          if (datas && datas.length > 0) {
            // Ambil data yang paling baru masuk (biasanya yang terakhir dalam array)
            const latestData = datas[datas.length - 1];

            // Tentukan item monitoring yang ingin ditampilkan
            const monitoringItemsToShow = [
              {
                label: "Suhu",
                value:
                  latestData.suhu !== undefined
                    ? `${latestData.suhu}¬∞C`
                    : "N/A",
              },
              {
                label: "Kelembaban",
                value:
                  latestData.kelembaban !== undefined
                    ? `${latestData.kelembaban}%`
                    : "N/A",
              },
              {
                label: "Kekeruhan",
                value:
                  latestData.turbidity !== undefined
                    ? `${latestData.turbidity} %`
                    : "N/A",
              },
              {
                label: "pH",
                value: latestData.ph !== undefined ? latestData.ph : "N/A",
              },
              // Tambahkan item lain sesuai kebutuhan dari struktur data Anda
            ];

            monitoringDataElement.innerHTML = monitoringItemsToShow
              .map(
                (item) => `
                  <div class="monitoring-item animate-fadeIn">
                      <span class="monitoring-label">${item.label} <span class="monitoring-value">${item.value}</span></span>
                  </div>
              `
              )
              .join("");
          } else {
            monitoringDataElement.innerHTML = `
                  <div class="monitoring-item">
                      <span class="monitoring-label">Tidak ada data monitoring</span>
                  </div>
              `;
          }
        }

        // Panggil updateMonitoringData saat halaman dimuat dan secara berkala
        updateMonitoringData();
        setInterval(updateMonitoringData, 2000); // Perbarui setiap 3 detik (sesuaikan sesuai kebutuhan)

        const fetchLatestPrediction = async () => {
          try {
            const response = await fetch("/all_predictions");
            if (!response.ok) {
              throw new Error("Failed to fetch latest predictions");
            }
            const predictionData = await response.json();
            console.log(
              "üöÄ ~ fetchAllPrediction ~ predictionData:",
              predictionData
            );
            // Ambil maksimal 5 prediksi terbaru
            const latestPredictions = predictionData.slice(-3).reverse();
            updatePredictionNotification(latestPredictions);
          } catch (error) {
            console.error("Error fetching latest predictions:", error);
            const notificationContainer = document.getElementById(
              "prediction-notification"
            );
            notificationContainer.innerHTML = `
                <div class="notification-card notification-yellow animate-slideInLeft" style="animation-delay: 0.1s">
                    <div class="notification-title">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 text-yellow-500 notification-icon">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 2h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                        <h2>Gagal memuat prediksi!</h2>
                    </div>
                    <p class="notification-text">
                        Terjadi kesalahan saat mengambil data prediksi terbaru.
                    </p>
                </div>
            `;
          }
        };

        // Function to update the prediction notifications in the UI
        const updatePredictionNotification = (predictions) => {
          const notificationContainer = document.getElementById(
            "prediction-notification"
          );
          notificationContainer.innerHTML = ""; // Clear previous notifications

          if (predictions && predictions.length > 0) {
            predictions.forEach((prediction, index) => {
              let borderColorClass = "";
              let titleColorClass = "";
              let titleText = "";
              let iconPath = "";

              if (prediction.kondisi === "ideal") {
                borderColorClass = "notification-green";
                titleColorClass = "text-green-700";
                titleText = "Kondisi Sistem Ideal!";
                iconPath = `<path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />`;
              } else {
                borderColorClass = "notification-yellow";
                titleColorClass = "text-yellow-700";
                titleText = "Kondisi Sistem Tidak Ideal!";
                iconPath = `<path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 2h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />`;
              }

              let reasonsHtml = "";
              if (prediction.reasons && prediction.reasons.length > 0) {
                reasonsHtml = `<p class="notification-text">${prediction.reasons.join(
                  ", "
                )}</p>`;
              }

              const notificationHtml = `
                    <div class="notification-card ${borderColorClass} animate-slideInLeft" style="animation-delay: ${
                0.1 * (index + 1)
              }s">
                        <div class="notification-title ${titleColorClass}">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 ${titleColorClass} notification-icon">
                                ${iconPath}
                            </svg>
                            <h2>${titleText}</h2>
                        </div>
                        ${reasonsHtml}
                        <p class="notification-time">${new Date(
                          prediction.timestamp
                        ).toLocaleString()}</p>
                    </div>
                `;
              notificationContainer.innerHTML += notificationHtml;
            });
          } else {
            notificationContainer.innerHTML = `
                <div class="notification-card notification-yellow animate-slideInLeft" style="animation-delay: 0.1s">
                    <div class="notification-title">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 text-yellow-500 notification-icon">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 2h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                        <h2>Belum ada prediksi terbaru!</h2>
                    </div>
                    <p class="notification-text">
                        Data prediksi akan muncul setelah sistem melakukan analisis.
                    </p>
                </div>
            `;
          }
        };

        // Fetch the latest predictions when the page loads and then periodically
        fetchLatestPrediction();
        setInterval(fetchLatestPrediction, 5000); // Fetch every 5 seconds
      })();
    </script>
  </body>
</html>
